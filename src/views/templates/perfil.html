<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - VivaBem</title>
    <link rel="stylesheet" href="/index.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">üçé VivaBem</div>
            <div class="nav-menu">
                <a href="/dashboard">Dashboard</a>
                <a href="/registrar">Registrar Refei√ß√£o</a>
                <a href="/historico">Hist√≥rico</a>
                <a href="/perfil" class="active">Perfil</a>
                <button id="btnLogout" class="btn btn-secondary">Sair</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>üë§ Meu Perfil</h1>
            <p>Gerencie suas informa√ß√µes e acompanhe seu progresso</p>
        </div>

        <div class="perfil-grid">
            <!-- Informa√ß√µes Pessoais -->
            <div class="card">
                <h2>üìã Informa√ß√µes Pessoais</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <label>Nome</label>
                        <p id="nome">-</p>
                    </div>
                    <div class="info-item">
                        <label>Email</label>
                        <p id="email">-</p>
                    </div>
                    <div class="info-item">
                        <label>Idade</label>
                        <p id="idade">-</p>
                    </div>
                    <div class="info-item">
                        <label>Tipo de Usu√°rio</label>
                        <p id="tipo">-</p>
                    </div>
                    <div class="info-item">
                        <label>Peso</label>
                        <p id="peso">-</p>
                    </div>
                    <div class="info-item">
                        <label>Altura</label>
                        <p id="altura">-</p>
                    </div>
                    <div class="info-item">
                        <label>IMC</label>
                        <p id="imc" class="imc-valor">-</p>
                    </div>
                    <div class="info-item full-width">
                        <label>Restri√ß√µes Alimentares</label>
                        <p id="restricoes">Nenhuma</p>
                    </div>
                </div>
            </div>

            <!-- Estat√≠sticas -->
            <div class="card">
                <h2>üìä Estat√≠sticas</h2>
                <div class="estatisticas-grid">
                    <div class="stat-box">
                        <div class="stat-icon">üçΩÔ∏è</div>
                        <div class="stat-content">
                            <h3 id="totalRefeicoes">0</h3>
                            <p>Total de Refei√ß√µes</p>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-content">
                            <h3 id="diasAtivos">0</h3>
                            <p>Dias Ativos</p>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-content">
                            <h3 id="adequadas">0</h3>
                            <p>Refei√ß√µes Adequadas</p>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-content">
                            <h3 id="percentualAdequadas">0%</h3>
                            <p>Taxa de Sucesso</p>
                        </div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-content">
                            <h3 id="mediaPorDia">0</h3>
                            <p>M√©dia por Dia</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recomenda√ß√µes Personalizadas -->
        <div class="card">
            <h2>üí° Suas Recomenda√ß√µes Personalizadas</h2>
            <div id="recomendacoes" class="recomendacoes-perfil">
                <p class="loading">Carregando recomenda√ß√µes...</p>
            </div>
        </div>

        <!-- An√°lise Semanal -->
        <div class="card">
            <h2>üìà An√°lise Semanal</h2>
            <div id="analiseSemanal">
                <p class="loading">Carregando an√°lise semanal...</p>
            </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="perfil-actions">
            <button id="btnEditar" class="btn btn-secondary" onclick="alert('Funcionalidade em desenvolvimento')">
                ‚úèÔ∏è Editar Perfil
            </button>
            <button id="btnExportar" class="btn btn-secondary">
                üì• Exportar Dados
            </button>
            <button id="btnLimpar" class="btn btn-danger">
                üóëÔ∏è Limpar Dados
            </button>
        </div>
    </div>

    <script type="module">
        let usuarioLogado = null;

        async function verificarLogin() {
            try {
                const response = await fetch('/api/usuarios/logado');
                const resultado = await response.json();

                if (resultado.sucesso) {
                    usuarioLogado = resultado.usuario;
                    carregarPerfil();
                } else {
                    window.location.href = '/login';
                }
            } catch (erro) {
                console.error('Erro ao verificar login:', erro);
                window.location.href = '/login';
            }
        }

        async function carregarPerfil() {
            try {
                const response = await fetch(`/api/usuarios/perfil/${usuarioLogado.id}`);
                const resultado = await response.json();

                if (resultado.sucesso) {
                    const perfil = resultado.perfil;
                    
                    // Informa√ß√µes pessoais
                    document.getElementById('nome').textContent = perfil.nome;
                    document.getElementById('email').textContent = perfil.email;
                    document.getElementById('idade').textContent = `${perfil.idade} anos`;
                    
                    const tipoTexto = {
                        'comum': 'üôÇ Usu√°rio Comum',
                        'diabetico': 'üíâ Usu√°rio Diab√©tico',
                        'atleta': 'üí™ Atleta (Hipertrofia)'
                    };
                    document.getElementById('tipo').textContent = tipoTexto[perfil.tipo] || perfil.tipo;
                    
                    document.getElementById('peso').textContent = `${perfil.peso} kg`;
                    document.getElementById('altura').textContent = `${perfil.altura} m`;
                    
                    // IMC
                    const imc = parseFloat(perfil.imc);
                    const imcElement = document.getElementById('imc');
                    imcElement.textContent = imc.toFixed(1);
                    imcElement.className = 'imc-valor ' + classificarIMC(imc);
                    
                    // Restri√ß√µes
                    if (perfil.restricoes && perfil.restricoes.length > 0) {
                        document.getElementById('restricoes').textContent = perfil.restricoes.join(', ');
                    }

                    // Estat√≠sticas
                    const stats = perfil.estatisticas;
                    document.getElementById('totalRefeicoes').textContent = stats.totalRefeicoes;
                    document.getElementById('diasAtivos').textContent = stats.diasAtivos;
                    document.getElementById('adequadas').textContent = stats.adequadas || 0;
                    document.getElementById('percentualAdequadas').textContent = `${stats.percentualAdequadas}%`;
                    document.getElementById('mediaPorDia').textContent = stats.mediaPorDia;

                    // Recomenda√ß√µes
                    const recContainer = document.getElementById('recomendacoes');
                    recContainer.innerHTML = `
                        <ul class="recomendacoes-list">
                            ${perfil.recomendacoes.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    `;
                }

                await carregarAnaliseSemanal();
            } catch (erro) {
                console.error('Erro ao carregar perfil:', erro);
            }
        }

        function classificarIMC(imc) {
            if (imc < 18.5) return 'baixo';
            if (imc < 25) return 'normal';
            if (imc < 30) return 'sobrepeso';
            return 'obesidade';
        }

        async function carregarAnaliseSemanal() {
            try {
                const response = await fetch(`/api/analises/semanal/${usuarioLogado.id}`);
                const resultado = await response.json();

                if (resultado.sucesso) {
                    const container = document.getElementById('analiseSemanal');
                    const resumo = resultado.resumoSemanal;

                    container.innerHTML = `
                        <div class="analise-semanal-grid">
                            <div class="semana-stat">
                                <h4>√çndice M√©dio</h4>
                                <div class="indice-grande">${resumo.indiceMedia}/100</div>
                            </div>
                            <div class="semana-stat">
                                <h4>Refei√ß√µes</h4>
                                <p>${resumo.totalRefeicoes}</p>
                            </div>
                            <div class="semana-stat">
                                <h4>M√©dia/Dia</h4>
                                <p>${resumo.mediaPorDia}</p>
                            </div>
                            <div class="semana-stat">
                                <h4>Dias Ativos</h4>
                                <p>${resumo.diasAtivos}/7</p>
                            </div>
                        </div>

                        <div class="semana-detalhes">
                            ${resultado.semana.map(dia => `
                                <div class="dia-semana-item">
                                    <div class="dia-label">
                                        <span>${dia.diaSemana}</span>
                                        <small>${dia.data}</small>
                                    </div>
                                    <div class="dia-barra">
                                        <div class="barra-fill" style="width: ${dia.analise.indice}%"></div>
                                    </div>
                                    <div class="dia-valor">${dia.analise.indice}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (erro) {
                console.error('Erro ao carregar an√°lise semanal:', erro);
            }
        }

        document.getElementById('btnExportar').addEventListener('click', async () => {
            try {
                const response = await fetch(`/api/refeicoes/usuario/${usuarioLogado.id}`);
                const resultado = await response.json();

                if (resultado.sucesso) {
                    const dados = {
                        usuario: usuarioLogado,
                        refeicoes: resultado.refeicoes,
                        exportadoEm: new Date().toISOString()
                    };

                    const json = JSON.stringify(dados, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `vivabem_${usuarioLogado.nome}_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();

                    alert('Dados exportados com sucesso!');
                }
            } catch (erro) {
                console.error('Erro ao exportar:', erro);
                alert('Erro ao exportar dados');
            }
        });

        document.getElementById('btnLimpar').addEventListener('click', async () => {
            const confirmacao = confirm(
                '‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° excluir TODOS os seus dados permanentemente!\n\n' +
                'Voc√™ tem certeza que deseja continuar?'
            );

            if (!confirmacao) return;

            const confirmaFinal = confirm(
                'Esta √© sua √∫ltima chance!\n\n' +
                'Todos os seus registros de refei√ß√µes ser√£o perdidos para sempre.\n\n' +
                'Deseja realmente continuar?'
            );

            if (confirmaFinal) {
                try {
                    const response = await fetch(`/api/usuarios/${usuarioLogado.id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('Conta exclu√≠da com sucesso');
                        window.location.href = '/login';
                    }
                } catch (erro) {
                    console.error('Erro ao excluir conta:', erro);
                    alert('Erro ao excluir conta');
                }
            }
        });

        document.getElementById('btnLogout').addEventListener('click', async () => {
            try {
                await fetch('/api/usuarios/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (erro) {
                console.error('Erro ao fazer logout:', erro);
            }
        });

        // Inicializa
        verificarLogin();
    </script>
</body>
</html>